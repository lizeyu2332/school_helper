<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.pro.mapper.OrderMapper">
    
    <resultMap id="BaseResultMap" type="com.example.pro.entity.Order">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="buyer_id" property="buyerId"/>
        <result column="seller_id" property="sellerId"/>
        <result column="price" property="price"/>
        <result column="status" property="status"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="pay_time" property="payTime"/>
        <result column="ship_time" property="shipTime"/>
        <result column="receive_time" property="receiveTime"/>
        <result column="product_title" property="productTitle"/>
    </resultMap>
    
    <insert id="insert" parameterType="com.example.pro.entity.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (product_id, buyer_id, seller_id, price, status, remark, create_time)
        VALUES (#{productId}, #{buyerId}, #{sellerId}, #{price}, #{status}, #{remark}, NOW())
    </insert>
    
    <select id="selectById" resultMap="BaseResultMap">
        SELECT * FROM `order` WHERE id = #{id}
    </select>
    
    <select id="selectByBuyerId" resultMap="BaseResultMap">
        SELECT 
            o.id,
            o.product_id,
            o.buyer_id,
            o.seller_id,
            o.price,
            o.status,
            o.remark,
            o.create_time,
            o.pay_time,
            o.ship_time,
            o.receive_time,
            p.title as product_title
        FROM `order` o 
        LEFT JOIN product p ON o.product_id = p.id 
        WHERE o.buyer_id = #{buyerId} 
        ORDER BY o.create_time DESC
    </select>
    
    <select id="selectBySellerId" resultMap="BaseResultMap">
        SELECT 
            o.id,
            o.product_id,
            o.buyer_id,
            o.seller_id,
            o.price,
            o.status,
            o.remark,
            o.create_time,
            o.pay_time,
            o.ship_time,
            o.receive_time,
            p.title as product_title
        FROM `order` o 
        LEFT JOIN product p ON o.product_id = p.id 
        WHERE o.seller_id = #{sellerId} 
        ORDER BY o.create_time DESC
    </select>
    
    <select id="selectByProductId" resultMap="BaseResultMap">
        SELECT * FROM `order` WHERE product_id = #{productId} ORDER BY create_time DESC
    </select>
    
    <select id="selectByBuyerAndProduct" resultMap="BaseResultMap">
        SELECT * FROM `order` 
        WHERE buyer_id = #{buyerId} AND product_id = #{productId} 
        ORDER BY create_time DESC 
        LIMIT 1
    </select>
    
    <update id="update" parameterType="com.example.pro.entity.Order">
        UPDATE `order`
        SET product_id = #{productId},
            buyer_id = #{buyerId},
            seller_id = #{sellerId},
            price = #{price},
            status = #{status},
            remark = #{remark},
            pay_time = #{payTime},
            ship_time = #{shipTime},
            receive_time = #{receiveTime}
        WHERE id = #{id}
    </update>
    
    <update id="updateStatus">
        UPDATE `order`
        SET status = #{status}
        <if test="status == 1">
            , pay_time = NOW()
        </if>
        <if test="status == 2">
            , ship_time = NOW()
        </if>
        <if test="status == 3">
            , receive_time = NOW()
        </if>
        WHERE id = #{id}
    </update>
    
</mapper>

